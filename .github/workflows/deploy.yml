name: Deploy Frontend to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allows manual trigger from GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Create SSH key file
        run: |
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > private_key.pem
          chmod 600 private_key.pem
      
      - name: Create .env file
        run: |
          cat > .env << 'EOF'
          REACT_APP_API_URL=${{ secrets.REACT_APP_API_URL }}
          EOF
      
      - name: Copy .env to EC2
        env:
          HOST: ${{ secrets.EC2_HOST }}
          USERNAME: ${{ secrets.EC2_USERNAME }}
        run: |
          scp -o StrictHostKeyChecking=no -i private_key.pem .env ${USERNAME}@${HOST}:~/Donationapp--frontend/.env
          echo "‚úÖ .env file copied to EC2"
      
      - name: Deploy to EC2
        env:
          HOST: ${{ secrets.EC2_HOST }}
          USERNAME: ${{ secrets.EC2_USERNAME }}
        run: |
          ssh -o StrictHostKeyChecking=no -i private_key.pem ${USERNAME}@${HOST} << 'ENDSSH'
            set -e
            
            echo "=========================================="
            echo "üöÄ Starting Frontend Deployment"
            echo "=========================================="
            
            cd ~/Donationapp--frontend
            
            echo ""
            echo "üì• Pulling latest code from GitHub..."
            
            # Stash any local changes
            if ! git diff-index --quiet HEAD --; then
              echo "‚ö†Ô∏è Local changes detected, stashing..."
              git stash
            fi
            
            # Fetch and reset to match GitHub
            git fetch origin main
            git reset --hard origin/main
            
            echo "‚úÖ Code synchronized with GitHub"
            
            echo ""
            echo "üì¶ Installing dependencies..."
            npm install || { echo "‚ùå npm install failed"; exit 1; }
            
            echo ""
            echo "üèóÔ∏è Building React app..."
            npm run build || { echo "‚ùå Build failed"; exit 1; }
            
            echo ""
            echo "üîÑ Restarting services..."
            
            # Check if using PM2
            if pm2 list | grep -q "donation-frontend"; then
              echo "Restarting PM2..."
              pm2 restart donation-frontend
            fi
            
            # Restart Nginx
            if systemctl is-active --quiet nginx; then
              echo "Restarting Nginx..."
              sudo systemctl restart nginx
            fi
            
            echo ""
            echo "üìä Service Status:"
            pm2 list 2>/dev/null || echo "PM2 not running"
            sudo systemctl status nginx --no-pager | head -n 5
            
            echo ""
            echo "=========================================="
            echo "‚úÖ Frontend Deployment Complete!"
            echo "=========================================="
          ENDSSH
      
      - name: Health Check
        env:
          HOST: ${{ secrets.EC2_HOST }}
        run: |
          echo "üè• Running health check..."
          sleep 10
          
          if curl -f http://${HOST} > /dev/null 2>&1; then
            echo "‚úÖ Frontend is healthy and responding!"
          else
            echo "‚ö†Ô∏è Warning: Frontend may not be responding correctly"
            exit 1
          fi
      
      - name: Cleanup
        if: always()
        run: |
          rm -f private_key.pem .env
          echo "üßπ Cleaned up sensitive files"